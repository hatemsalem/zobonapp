<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">
	<import resource="datasource-tx-jpa.xml" />
	<import resource="offers-workers.xml"/>
	<bean id="inserter" class="zobonapp.core.setup.Inserter" />
	<camelContext xmlns="http://camel.apache.org/schema/spring" errorHandlerRef="dlc">
		<errorHandler id="dlc" type="DeadLetterChannel" deadLetterUri="direct:DLC">
			<redeliveryPolicy maximumRedeliveries="0" retryAttemptedLogLevel="DEBUG"/>
		</errorHandler>
		<dataFormats>
			<json id="abc" library="Jackson" />
		</dataFormats>
		<route id="logging">
			<from uri="direct:DLC"/>
			<setBody >
				<simple>${date:now:yyyyMMdd-HH:mm:ss}::: Record: ${body}, Exception: ${exception.message},\nStackTrace:\n${exception.stacktrace}\n===================\n</simple>
			</setBody>
			<to uri="file://c://zadata/logs?fileName=dlc.txt&amp;fileExist=Append"/>
		</route>
		<route>
			<from uri="file://c://zadata/init/res/?recursive=true&amp;delete=true&amp;initialDelay=120000" />
			<to uri="bean:inserter?method=renameLogoFile"></to>
			<log message="====Loop====${headers[za.recipients]}\n" loggingLevel="WARN" />
			<recipientList>
				<header>za.recipients</header>
			</recipientList>
		</route>
		<route>
			<from uri="file://c://zadata/init/cat_res/?recursive=true&amp;delete=true&amp;initialDelay=10000" />
			<to uri="bean:inserter?method=renameCatLogoFile"></to>
			<log message="====Loop====${headers[za.recipients]}\n" loggingLevel="WARN" />
			<recipientList>
				<header>za.recipients</header>
			</recipientList>
		</route>

		<route autoStartup="true">
			<from uri="file://c:/zadata/init/hotlines/?delete=true&amp;initialDelay=10000" />

			<log message="Hello ${file:absolute.path}" loggingLevel="WARN" />
			<unmarshal ref="abc" />
			<!-- <log message="====Unmarshaled====\n${body}" loggingLevel="WARN"/> -->

			<to uri="bean:inserter?method=insertItem"></to>
			<!-- <to uri="file://myfiles/"></to> <log message="Hello ${file:absolute.path}" loggingLevel="WARN" /> -->
		</route>

		<route autoStartup="true">
			<from uri="file://c:/zadata/init/hotlines/issues/?delete=true&amp;initialDelay=60000" />

			<log message="Hello ${file:absolute.path}" loggingLevel="WARN" />
			<unmarshal ref="abc" />
			<!-- <log message="====Unmarshaled====\n${body}" loggingLevel="WARN"/> -->

			<to uri="bean:inserter?method=insertItemWithIssues"></to>

		</route>

		<route>
			<from uri="file://c:/zadata/init/?delete=true&amp;fileName=categories.csv&amp;initialDelay=500" />
			<unmarshal>
				<csv skipFirstLine="true" />
			</unmarshal>
			<split>
				<simple>body</simple>
				<to uri="bean:inserter?method=insertGroups"></to>
			</split>

		</route>
		<route autoStartup="false">
			<from uri="timer://worker1?period=10m&amp;delay=1000"></from>
			<log message="====Timer triggering====" loggingLevel="WARN"/>
			<to uri="bean:yabalashWorker?method=run"></to>
		</route>
		<route>
			<from uri="timer://worker2?period=2m&amp;delay=1000"></from>
			<log message="====Timer triggering====" loggingLevel="WARN"/>
			<to uri="bean:oroodWorker?method=run"></to>
		</route>
	</camelContext>
</beans>
